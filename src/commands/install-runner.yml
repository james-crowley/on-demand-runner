description: >
  Configure On Demand Runners
parameters:
  circle-token:
    default: CIRCLE_TOKEN
    description: |
      A valid Circle token for interacting with the CircleCI API. Please see
      https://circleci.com/docs/2.0/managing-api-tokens/ for more details.
    type: env_var_name
  circleci-namespace:
    default: CIRCLECI_NAMESPACE
    description: |
      A CircleCI generated namespace for your organization. Please see
      https://circleci.com/docs/2.0/orb-concepts/#namespaces for more details.
    type: env_var_name
  resource_class:
    default: RESOURCE_CLASS
    description: |
      Name of the resource class that will be generated and used for On Demand Runners. 
      If not resource class is given a default will be selected using 'pipeline.id'. PLEASE note you
      need to set resource class to a name that is not currently being used, as the resource class will be deleted.
    type: env_var_name
steps:
  - run:
      name: Setting Defaults if Variables are not Set
      command: |
          echo "export RESOURCE_CLASS=$(echo ${RESOURCE_CLASS:-<< pipeline.id	>>})" >> $BASH_ENV
          echo "export ANSIBLE_FORCE_COLOR=$(echo ${ANSIBLE_FORCE_COLOR:-true})" >> $BASH_ENV
          source $BASH_ENV  
  - run: Configure On Demand Runners
    working_directory: ~/project/on-demand-runners/auto-runner/
    command: |
        ansible-playbook -i aws_ec2.yml install-runner.yml -u ansible -e "NAMESPACE=$CIRCLECI_NAMESPACE RESOURCE_CLASS=$RESOURCE_CLASS CIRCLE_TOKEN=$CIRCLE_TOKEN RESOURCE_CLASS_CREATION=true RUNNER_TOKEN_CREATION=true target_hosts=all"