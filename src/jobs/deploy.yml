description: >
  Provision and Configure On Demand Runners

executor: python-docker

parameters:
  aws-region:
    default: AWS_DEFAULT_REGION
    description: |
      Env var of AWS region to operate in. If no region is provided US-EAST-1 
      will be selected.
    type: env_var_name
  aws-secret-access-key:
    default: AWS_SECRET_ACCESS_KEY
    description: |
      AWS secret key for IAM role. Set this to the name of
      the environment variable you will use to hold this
      value, i.e. $AWS_SECRET_ACCESS_KEY.
    type: env_var_name
  aws-access-key-id:
    default: AWS_ACCESS_KEY_ID
    description: |
      AWS access key id for IAM role. Set this to the name of
      the environment variable you will use to hold this
      value, i.e. AWS_ACCESS_KEY.
    type: env_var_name
  aws-ami-id:
    default: AWS_AMI_ID
    description: |
      An AWS AMI(Amazon Machine Image) ID for the image you want
      spun up as an EC2 instance. Set this to the name of
      the environment variable you will use to hold this
      value, i.e. AWS_AMI_ID.
    type: env_var_name
  aws-security-group-id:
    default: AWS_SECURITY_GROUP_ID
    description: |
      The ID of the AWS security group you want to be applied
      to the EC2 instance(s). Set this to the name of
      the environment variable you will use to hold this
      value, i.e. AWS_SECURITY_GROUP_ID.
    type: env_var_name
  aws-vpc-id:
    default: AWS_VPC_ID
    description: |
      The ID of the VPC you want the EC2 instance(s) to be 
      deployed in. If left blank, the default VPC will be selected.
      Set this to the name of the environment variable you will use 
      to hold this value, i.e. AWS_VPC_ID.
    type: env_var_name
  aws-ssh-key:
    default: AWS_SSH_KEY
    description: |
      The name of the SSH key you want the EC2 instance(s) to have
      injected. Please note you need to already have uploaded the key
      to AWS to reference the SSH key name. Set this to the name of 
      the environment variable you will use to hold this value, i.e. AWS_SSH_KEY.
    type: env_var_name
  aws-instance-type:
    default: AWS_INSTANCE_TYPE
    description: |
      A valid instance type/size for a EC2 instance. If no instance type is provided
      a t2.mirco will be selected. Set this to the name of the environment variable 
      you will use to hold this value, i.e. AWS_INSTANCE_TYPE.
    type: env_var_name
  circle-token:
    default: CIRCLE_TOKEN
    description: |
      A valid Circle token for interacting with the CircleCI API. Please see
      https://circleci.com/docs/2.0/managing-api-tokens/ for more details.
    type: env_var_name
  circleci-namespace:
    default: CIRCLECI_NAMESPACE
    description: |
      A CircleCI generated namespace for your organization. Please see
      https://circleci.com/docs/2.0/orb-concepts/#namespaces for more details.
    type: env_var_name
  number_of_numbers:
    default: NUMBER_OF_RUNNERS
    description: |
      Number of on demand runners to deploy. If no number is provided only 1 
      on demand runner will be deployed. PLEASE be careful setting this number.
    type: env_var_name
  number_of_waits:
    default: NUMBER_OF_WAITS
    description: |
      Number of on waits(10 seconds each) for the EC2 instance(s) to be provisioned before failure.
      If no number is provided 18 waits(3 minutes) will be selected.
    type: env_var_name
  ansible_git_url:
    default: ANSIBLE_GIT_URL
    description: |
      The GIT URL for the on demand runner Ansible roles, playbooks, and tasks. You should not
      change this unless you are debugging. If no URL is provided the URL will be https://github.com/james-crowley/on-demand-runners.git.
    type: env_var_name
  ansible_git_branch:
    default: ANSIBLE_GIT_BRANCH
    description: |
      The GIT branch for the on demand runner Ansible roles, playbooks, and tasks. You should not
      change this unless you are debugging. If no branch is provided the branch will be 'main'.
    type: env_var_name
  version:
    default: 2.9.*
    description: Ansible Version To Be Installed
    type: string
steps:
  - install-ansible:
      version: <<parameters.version>>
  - install-dependencies
  - provision
  - install-runner

